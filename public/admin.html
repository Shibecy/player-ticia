<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard ‚Ä¢ TI&CIA Player</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f7fa;padding:24px}
  .header{background:#fff;border-radius:12px;padding:24px;margin-bottom:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08);text-align:center}
  .logo{height:40px}
  h1{font-size:28px;font-weight:700;color:#1a202c;margin-bottom:20px}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:24px;background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  input,button{padding:10px 16px;border:1px solid #e2e8f0;border-radius:8px;font-size:14px;font-family:inherit}
  input[type="checkbox"]{width:auto;padding:0;margin-right:6px}
  button{background:#3182ce;color:#fff;border:none;cursor:pointer;transition:all 0.2s;font-weight:500}
  button:hover{background:#2c5aa0}
  .grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(350px,1fr))}
  .card{background:#fff;border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}
  .card h2{margin:0 0 16px 0;font-size:20px;color:#1a202c;text-transform:capitalize}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:12px 16px;margin-top:12px}
  .kv-label{color:#718096;font-size:14px}
  .kv-value{color:#1a202c;font-weight:500;text-align:right}
  .muted{color:#718096;font-size:13px}
  .status{text-align:center;color:#718096;margin:16px 0}
  .btn-export{background:#38a169;color:#fff;border:none;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:13px;text-decoration:none;display:inline-block;margin-top:12px}
  .btn-export:hover{background:#2f855a}
</style>
</head>
<body>
  <div class="header">
    <img src="http://tiecia.com.br/player/logo.png" alt="TI&CIA" class="logo" />
    <h1>Dashboard - Relat√≥rio Di√°rio</h1>
  </div>

  <div class="controls">
    <label>Data: <input type="date" id="date"></label>
    <button id="btnReload">Atualizar</button>
    <label class="muted"><input type="checkbox" id="autorefresh" /> Auto-refresh (30s)</label>
    <span class="muted" id="status"></span>
  </div>

  <section id="stores" class="grid"></section>

<script>
const dateEl = document.getElementById('date');
const statusEl = document.getElementById('status');
const autorefresh = document.getElementById('autorefresh');
const storesEl = document.getElementById('stores');
document.getElementById('btnReload').addEventListener('click', loadAll);

dateEl.value = new Date().toISOString().slice(0,10);

function fmtHMS(total){
  total = Math.max(0, Math.floor(total||0));
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  const s = total%60;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

async function fetchJSON(url){
  const r = await fetch(url);
  if (!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

async function loadStoreCard(storeId){
  const date = dateEl.value;
  const [rep, now] = await Promise.all([
    fetchJSON(`/api/report/daily?date=${date}&storeId=${encodeURIComponent(storeId)}`),
    fetchJSON(`/api/now-playing?storeId=${encodeURIComponent(storeId)}`)
  ]);
  const time = fmtHMS(rep.totals?.totalSecondsPlayed||0);
  const start = rep.totals?.dayStart ? new Date(rep.totals.dayStart).toLocaleTimeString() : '‚Äî';
  const np = now.nowPlaying ? `${now.nowPlaying.artist || '-'} ‚Äì ${now.nowPlaying.title || '-'}` : '‚Äî';
  return { storeId, time, start, nowPlaying: np, date };
}

function renderStoreCard({storeId, time, start, nowPlaying, date}){
  const id = `store-${storeId}`;
  let el = document.getElementById(id);
  if (!el){
    el = document.createElement('div');
    el.className = 'card';
    el.id = id;
    storesEl.appendChild(el);
  }
  el.innerHTML = `
    <h2>${storeId}</h2>
    <div class="kv">
      <div class="kv-label">Tempo de execu√ß√£o</div>
      <div class="kv-value">${time}</div>
      <div class="kv-label">Come√ßou √†s</div>
      <div class="kv-value">${start}</div>
      <div class="kv-label">M√∫sica atual</div>
      <div class="kv-value">${nowPlaying}</div>
    </div>
    <a class="btn-export" href="/api/report/csv?date=${encodeURIComponent(date)}&storeId=${encodeURIComponent(storeId)}">üì• Exportar CSV</a>
  `;
}

async function loadAll(){
  statusEl.textContent = 'carregando‚Ä¶';
  statusEl.style.color = '#718096';
  try{
    const stores = (await fetchJSON('/api/stores')).stores || [];
    if (!stores.length){
      storesEl.innerHTML = '<div style="text-align:center;padding:40px;color:#718096">Nenhuma loja com dados ainda. As lojas aparecer√£o aqui quando os players come√ßarem a tocar.</div>';
      statusEl.textContent = 'Aguardando dados‚Ä¶';
      return;
    }
    storesEl.innerHTML = '';
    for (const s of stores){
      try{
        const data = await loadStoreCard(s);
        renderStoreCard(data);
      }catch(e){
        console.error('Erro ao carregar loja', s, e);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<h2>${s}</h2><div class="muted">Sem dados para esta loja ainda.</div>`;
        storesEl.appendChild(card);
      }
    }
    statusEl.textContent = '‚úÖ Atualizado: ' + new Date().toLocaleTimeString();
    statusEl.style.color = '#38a169';
  }catch(e){
    statusEl.textContent = '‚ùå Erro: ' + e.message;
    statusEl.style.color = '#e53e3e';
    console.error('Erro completo:', e);
    storesEl.innerHTML = '<div style="text-align:center;padding:40px;color:#e53e3e">Erro ao carregar dados. Verifique o console para mais detalhes.</div>';
  }
}

let iv=null;
autorefresh.addEventListener('change', ()=>{
  if (autorefresh.checked){ iv = setInterval(loadAll, 30000); }
  else { clearInterval(iv); iv=null; }
});

loadAll();
</script>
</body>
</html>
