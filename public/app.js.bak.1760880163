const audio = document.getElementById('audio');
const btnPlay = document.getElementById('btn-play');
const btnPause = document.getElementById('btn-pause');
const btnNext = document.getElementById('btn-next');
const btnLike = document.getElementById('btn-like');
const btnDislike = document.getElementById('btn-dislike');
const elArtist = document.getElementById('artist');
const elTitle = document.getElementById('title');
const elSeek = document.getElementById('seek');
const elElapsed = document.getElementById('elapsed');
const elDuration = document.getElementById('duration');

const clientId = (() => {
  const k = 'player_client_id';
  let id = localStorage.getItem(k);
  if (!id) { id = Math.random().toString(36).slice(2); localStorage.setItem(k, id); }
  return id;
})();

let tracks = [];
let idx = 0;
let likeState = null; // 'like' | 'dislike' | null

function fmt(sec){
  sec = Math.max(0, Math.floor(sec||0));
  const m = Math.floor(sec/60); const s = sec%60; return `${m}:${s.toString().padStart(2,'0')}`;
}

function setLikeUI(state){
  likeState = state;
  btnLike.classList.toggle('active', state === 'like');
  btnDislike.classList.toggle('active', state === 'dislike');
}

async function fetchLikeState(){
  const t = tracks[idx]; if (!t) return setLikeUI(null);
  const q = new URLSearchParams({ trackId: t.id, clientId });
  const r = await fetch(`/api/like/state?${q.toString()}`);
  if (!r.ok) return setLikeUI(null);
  const j = await r.json();
  setLikeUI(j.state || null);
}

async function loadTracks(){
  const res = await fetch('/api/tracks');
  tracks = await res.json();
  if (tracks.length) selectTrack(0);
}

function selectTrack(i){
  if (!tracks.length) return;
  idx = (i + tracks.length) % tracks.length;
  const t = tracks[idx];
  audio.src = t.url;
  elArtist.textContent = t.artist || 'Artista';
  elTitle.textContent = t.title;
  setLikeUI(null);
  fetchLikeState();
}

async function logEvent(type){
  const trackId = tracks[idx]?.id || null;
  const positionSec = audio.currentTime || 0;
  await fetch('/api/events',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ clientId, type, trackId, positionSec })
  });
}

btnPlay.onclick = async ()=>{ await audio.play(); await logEvent('play'); };
btnPause.onclick = async ()=>{ audio.pause(); await logEvent('pause'); };
btnNext.onclick = ()=>{ if(!tracks.length) return; selectTrack(idx+1); audio.play(); logEvent('resume'); };

async function rate(like){
  const trackId = tracks[idx]?.id; if(!trackId) return;
  const r = await fetch('/api/like',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ trackId, clientId, like }) });
  const j = await r.json().catch(()=>({}));
  setLikeUI(j.state || (like ? 'like' : 'dislike'));
}
btnLike.onclick = ()=> rate(true);
btnDislike.onclick = ()=> rate(false);

audio.addEventListener('ended', ()=>{ btnNext.click(); });
audio.addEventListener('timeupdate', ()=>{
  elSeek.value = (audio.currentTime / (audio.duration||1)) * 100;
  elElapsed.textContent = fmt(audio.currentTime);
  elDuration.textContent = fmt(audio.duration||0);
});
elSeek.addEventListener('input', ()=>{
  if (!audio.duration) return;
  const to = (elSeek.value/100) * audio.duration;
  audio.currentTime = to;
});

window.addEventListener('focus', ()=> logEvent('resume'));
window.addEventListener('blur', ()=> logEvent('pause'));

loadTracks();
